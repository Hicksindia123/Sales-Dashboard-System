<!DOCTYPE html>
<html>
<head>
  <title>Sales Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f3f3f3; }
    .metrics { display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; }
    .metric-card {
      background: white;
      padding: 15px 20px;
      margin: 10px;
      box-shadow: 0 2px 6px #ccc;
      border-radius: 8px;
      width: 23%;
      text-align: center;
    }
    .filter-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .filter-group label { display: flex; flex-direction: column; font-weight: bold; }
    .chart-section { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 20px; }
    canvas { background: white; border-radius: 8px; padding: 10px; width: 48% !important; height: 300px !important; }
    table {
      width: 100%; border-collapse: collapse; background: white;
    }
    th, td {
      border: 1px solid #ccc; padding: 8px; text-align: left;
    }
    th { background: #007BFF; color: white; }
    .legend-container { max-height: 100px; overflow: hidden; position: relative; }
    .legend-container.expanded { max-height: none; }
    .toggle-legend { cursor: pointer; color: #007BFF; text-align: center; margin-top: 5px; }
  </style>
</head>
<body>

<h2>Sales Dashboard</h2>

<div class="metrics">
  <div class="metric-card" id="totalSale">Total Sale: ₹0</div>
  <div class="metric-card" id="avgSale">Average Sale: ₹0</div>
  <div class="metric-card" id="maxSale">Max Sale: ₹0</div>
  <div class="metric-card" id="billCount">Total Bills: 0</div>
</div>

<div class="filter-group">
  <label>From Date <input type="date" id="fromDate"></label>
  <label>To Date <input type="date" id="toDate"></label>
  <label>Rep <input type="text" id="repFilter" class="autocomplete"></label>
  <label>City <input type="text" id="cityFilter" class="autocomplete"></label>
  <label>State <input type="text" id="stateFilter" class="autocomplete"></label>
  <label>Distributor <input type="text" id="distributorFilter" class="autocomplete"></label>
  <button onclick="loadData()">Load</button>
</div>

<div class="chart-section">
  <div>
    <canvas id="statePie"></canvas>
    <div class="legend-container" id="stateLegend"></div>
    <div class="toggle-legend" onclick="toggleLegend()">Show More ▼</div>
  </div>
  <canvas id="repBar"></canvas>
</div>

<table id="salesTable">
  <thead>
    <tr>
      <th>Bill No.</th>
      <th>Bill Date</th>
      <th>Bill Amount</th>
      <th>Distributor</th>
      <th>City</th>
      <th>State</th>
      <th>Rep</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  let repList = [], cityList = [], distributorList = [], stateList = [];
  let stateChart;

  function loadData() {
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;
    const repFilter = document.getElementById("repFilter").value.toLowerCase();
    const cityFilter = document.getElementById("cityFilter").value.toLowerCase();
    const stateFilter = document.getElementById("stateFilter").value.toLowerCase();
    const distributorFilter = document.getElementById("distributorFilter").value.toLowerCase();

    fetch(`https://script.google.com/macros/s/AKfycbzP8wroEEmje9M-fQfQZL3xOl01ilmgXG6vWR4gS_8mqQf1sj4nGmtoOqQzSeskHetXEA/exec?from=${from}&to=${to}`)
      .then(res => res.json())
      .then(data => {
        repList = [...new Set(data.rawData.map(r => r.rep))];
        cityList = [...new Set(data.rawData.map(r => r.city))];
        stateList = [...new Set(data.rawData.map(r => r.state))];
        distributorList = [...new Set(data.rawData.map(r => r.distributor))];
        enableAutocomplete();

        let filtered = data.rawData.filter(row =>
          row.rep.toLowerCase().includes(repFilter) &&
          row.city.toLowerCase().includes(cityFilter) &&
          row.state.toLowerCase().includes(stateFilter) &&
          row.distributor.toLowerCase().includes(distributorFilter)
        );

        renderTable(filtered);
        renderSummary(filtered);
        renderPieChart(data.stateWise);
        renderBarChart(data.repWise);
      });
  }

  function enableAutocomplete() {
    $("#repFilter").autocomplete({ source: repList });
    $("#cityFilter").autocomplete({ source: cityList });
    $("#stateFilter").autocomplete({ source: stateList });
    $("#distributorFilter").autocomplete({ source: distributorList });
  }

  function renderTable(data) {
    const tbody = document.querySelector("#salesTable tbody");
    tbody.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.billNo || "-"}</td>
        <td>${row.billDate}</td>
        <td>${row.billAmount}</td>
        <td>${row.distributor}</td>
        <td>${row.city}</td>
        <td>${row.state}</td>
        <td>${row.rep}</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderSummary(data) {
    const total = data.reduce((sum, r) => sum + Number(r.billAmount), 0);
    const avg = data.length ? (total / data.length).toFixed(2) : 0;
    const max = data.reduce((max, r) => Math.max(max, Number(r.billAmount)), 0);

    document.getElementById("totalSale").innerText = `Total Sale: ₹${total}`;
    document.getElementById("avgSale").innerText = `Average Sale: ₹${avg}`;
    document.getElementById("maxSale").innerText = `Max Sale: ₹${max}`;
    document.getElementById("billCount").innerText = `Total Bills: ${data.length}`;
  }

  function renderPieChart(data) {
    const ctx = document.getElementById('statePie').getContext('2d');
    if (stateChart) stateChart.destroy();
    const colors = Object.keys(data).map(() => `hsl(${Math.random()*360}, 70%, 70%)`);
    stateChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.keys(data),
        datasets: [{
          data: Object.values(data),
          backgroundColor: colors
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });

    const legendHtml = Object.entries(data).map(([state, value], index) => `
      <div><span style="display:inline-block;width:12px;height:12px;background-color:${colors[index]};margin-right:5px;"></span>
      ${state} - ₹${value}</div>
    `).join('');
    document.getElementById("stateLegend").innerHTML = legendHtml;
  }

  function renderBarChart(data) {
    const ctx = document.getElementById('repBar').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(data),
        datasets: [{
          label: 'Rep Wise Sales',
          data: Object.values(data),
          backgroundColor: 'skyblue'
        }]
      },
      options: { responsive: true }
    });
  }

  function toggleLegend() {
    const container = document.getElementById("stateLegend");
    container.classList.toggle("expanded");
    const toggle = document.querySelector(".toggle-legend");
    toggle.innerText = container.classList.contains("expanded") ? "Show Less ▲" : "Show More ▼";
  }
</script>

</body>
</html>
