<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">

  <h2 class="text-2xl font-bold mb-4">Sales Dashboard</h2>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow p-4 text-center" id="totalSale">Total Sale: ₹0</div>
    <div class="bg-white rounded-xl shadow p-4 text-center" id="avgSale">Average Sale: ₹0</div>
    <div class="bg-white rounded-xl shadow p-4 text-center" id="maxSale">Max Sale: ₹0</div>
    <div class="bg-white rounded-xl shadow p-4 text-center" id="billCount">Total Bills: 0</div>
  </div>

  <div class="flex flex-wrap gap-4 mb-6 items-end">
    <div><label class="block font-medium">From:<input type="date" id="fromDate" class="mt-1 p-2 rounded border w-44"></label></div>
    <div><label class="block font-medium">To:<input type="date" id="toDate" class="mt-1 p-2 rounded border w-44"></label></div>
    <div><label class="block font-medium">Rep:<select id="repFilter" multiple class="w-44"></select></label></div>
    <div><label class="block font-medium">City:<select id="cityFilter" multiple class="w-44"></select></label></div>
    <div><label class="block font-medium">State:<select id="stateFilter" multiple class="w-44"></select></label></div>
    <div><label class="block font-medium">Distributor:<select id="distributorFilter" multiple class="w-44"></select></label></div>
    <button onclick="loadData()" class="bg-blue-600 text-white px-4 py-2 rounded shadow">Load</button>
  </div>

  <div class="bg-white rounded-xl shadow p-4 mb-6">
    <canvas id="repBar" height="200"></canvas>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow p-4 overflow-y-auto max-h-72">
      <h3 class="font-semibold mb-2">State-wise Sales</h3>
      <table class="w-full text-sm">
        <thead><tr><th>State</th><th>Total Sale</th></tr></thead>
        <tbody id="stateSummary"></tbody>
      </table>
    </div>
    <div class="bg-white rounded-xl shadow p-4 overflow-y-auto max-h-72">
      <h3 class="font-semibold mb-2">City-wise Sales</h3>
      <table class="w-full text-sm">
        <thead><tr><th>City</th><th>Total Sale</th></tr></thead>
        <tbody id="citySummary"></tbody>
      </table>
    </div>
    <div class="bg-white rounded-xl shadow p-4 overflow-y-auto max-h-72">
      <h3 class="font-semibold mb-2">Distributor-wise Sales</h3>
      <table class="w-full text-sm">
        <thead><tr><th>Distributor</th><th>Total Sale</th></tr></thead>
        <tbody id="distributorSummary"></tbody>
      </table>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow p-4">
    <h3 class="font-semibold mb-2">Detailed Sales Data</h3>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr><th>Bill No.</th><th>Bill Date</th><th>Bill Amount</th><th>Distributor</th><th>City</th><th>State</th><th>Rep</th></tr>
        </thead>
        <tbody id="salesTableBody"></tbody>
      </table>
    </div>
  </div>

<script>
  let repChart;
  function loadData() {
    const from = $('#fromDate').val();
    const to = $('#toDate').val();
    const repF = $('#repFilter').val() || [];
    const cityF = $('#cityFilter').val() || [];
    const stateF = $('#stateFilter').val() || [];
    const distF = $('#distributorFilter').val() || [];

    fetch(`https://script.google.com/macros/s/AKfycbyMFLEnwplCG2dNUMTT6R6ItCUlYWP6mJS6wPNbYKIeEzdVMIyCQUKiYpMaB5DY9Ac61g/exec?from=${from}&to=${to}`)
      .then(r => r.json())
      .then(data => {
        const raw = data.rawData;
        populateFilter('#repFilter', raw.map(r=>r.rep));
        populateFilter('#cityFilter', raw.map(r=>r.city));
        populateFilter('#stateFilter', raw.map(r=>r.state));
        populateFilter('#distributorFilter', raw.map(r=>r.distributor));

        const filtered = raw.filter(r => {
          const dt = new Date(r.billDate+'T00:00:00');
          return (!from || dt >= new Date(from+'T00:00:00')) &&
                 (!to   || dt <= new Date(to+'T23:59:59')) &&
                 (repF.length == 0 || repF.includes(r.rep)) &&
                 (cityF.length == 0 || cityF.includes(r.city)) &&
                 (stateF.length == 0 || stateF.includes(r.state)) &&
                 (distF.length == 0 || distF.includes(r.distributor));
        });

        renderTable(filtered);
        renderBar(filtered);
        renderSummaries(filtered);
        renderMetrics(filtered);
      });
  }

  function populateFilter(selector, list) {
    const u = Array.from(new Set(list.sort()));
    const el = $(selector).empty();
    u.forEach(v=> el.append(`<option>${v}</option>`));
    el.select2({ width: '100%', placeholder: 'Select' });
  }

  function renderTable(data) {
    const tbody = $('#salesTableBody').empty();
    data.forEach(r => tbody.append(`
      <tr><td>${r.billNo}</td><td>${r.billDate}</td><td>${r.billAmount}</td><td>${r.distributor}</td><td>${r.city}</td><td>${r.state}</td><td>${r.rep}</td></tr>`));
  }

  function renderBar(data) {
    const sales = {};
    data.forEach(r => sales[r.rep] = (sales[r.rep]||0)+Number(r.billAmount));
    const labels = Object.keys(sales), values = Object.values(sales);
    const ctx = document.getElementById('repBar').getContext('2d');
    if (repChart) repChart.destroy();
    repChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ data: values, label: 'Sales', backgroundColor: '#3B82F6' }] },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { autoSkip: false, maxRotation: 90, minRotation: 45 } } } }
    });
  }

  function renderSummaries(data) {
    const s={}, c={}, d={};
    data.forEach(r=>{
      s[r.state] = (s[r.state]||0)+Number(r.billAmount);
      c[r.city] = (c[r.city]||0)+Number(r.billAmount);
      d[r.distributor] = (d[r.distributor]||0)+Number(r.billAmount);
    });
    sortAndFill(s,'#stateSummary');
    sortAndFill(c,'#citySummary');
    sortAndFill(d,'#distributorSummary');
  }

  function renderMetrics(data) {
    const total = data.reduce((sum, r) => sum + Number(r.billAmount), 0);
    const avg = data.length ? total / data.length : 0;
    const max = Math.max(...data.map(r => Number(r.billAmount)), 0);
    $('#totalSale').text(`Total Sale: ₹${total.toLocaleString()}`);
    $('#avgSale').text(`Average Sale: ₹${avg.toFixed(2)}`);
    $('#maxSale').text(`Max Sale: ₹${max.toLocaleString()}`);
    $('#billCount').text(`Total Bills: ${data.length}`);
  }

  function sortAndFill(obj, sel) {
    const arr = Object.entries(obj).sort((a,b)=>b[1]-a[1]);
    const tbody = $(sel).empty();
    arr.forEach(([k,v])=> tbody.append(`<tr><td>${k}</td><td>₹${v.toLocaleString()}</td></tr>`));
  }

  $(document).ready(loadData);
</script>
</body>
</html>
