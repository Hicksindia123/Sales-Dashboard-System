<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sales Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .select2-container--default .select2-selection--multiple {
      background-color: black !important;
      color: white !important;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
      background-color: #4a5568;
      border: none;
      color: white;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-800 via-indigo-900 to-blue-900 text-white p-6 font-sans">

<!-- ... rest of your HTML as-is till script tag ... -->

<script>
  let repChart;

  function loadData() {
    const from = $('#fromDate').val();
    const to = $('#toDate').val();
    const repF = $('#repFilter').val() || [];
    const cityF = $('#cityFilter').val() || [];
    const stateF = $('#stateFilter').val() || [];
    const distF = $('#distributorFilter').val() || [];

    fetch(`https://script.google.com/macros/s/AKfycbyMFLEnwplCG2dNUMTT6R6ItCUlYWP6mJS6wPNbYKIeEzdVMIyCQUKiYpMaB5DY9Ac61g/exec?from=${from}&to=${to}`)
      .then(r => r.json())
      .then(data => {
        const raw = data.rawData;
        populateFilter('#repFilter', raw.map(r=>r.rep));
        populateFilter('#cityFilter', raw.map(r=>r.city));
        populateFilter('#stateFilter', raw.map(r=>r.state));
        populateFilter('#distributorFilter', raw.map(r=>r.distributor));

        const filtered = raw.filter(r => {
          const dt = new Date(r.billDate+'T00:00:00');
          return (!from || dt >= new Date(from+'T00:00:00')) &&
                 (!to   || dt <= new Date(to+'T23:59:59')) &&
                 (repF.length == 0 || repF.includes(r.rep)) &&
                 (cityF.length == 0 || cityF.includes(r.city)) &&
                 (stateF.length == 0 || stateF.includes(r.state)) &&
                 (distF.length == 0 || distF.includes(r.distributor));
        });

        renderTable(filtered);
        renderBar(filtered);
        renderSummaries(filtered);
        renderMetrics(filtered);
      });
  }

  function populateFilter(selector, list) {
    const u = Array.from(new Set(list.sort()));
    const el = $(selector).empty();
    u.forEach(v => el.append(`<option>${v}</option>`));
    el.select2({ width: '100%', placeholder: 'Select' });
  }

  function renderTable(data) {
    const tbody = $('#salesTableBody').empty();
    data.forEach(r => tbody.append(`
      <tr><td>${r.billNo}</td><td>${r.billDate}</td><td>${r.billAmount}</td><td>${r.distributor}</td><td>${r.city}</td><td>${r.state}</td><td>${r.rep}</td></tr>`));
  }

  function renderBar(data) {
    const sales = {};
    data.forEach(r => sales[r.rep] = (sales[r.rep] || 0) + Number(r.billAmount));
    const sorted = Object.entries(sales).sort((a, b) => b[1] - a[1]);
    const labels = sorted.map(([rep]) => rep);
    const values = sorted.map(([_, amount]) => amount);

    const colors = ['#60a5fa', '#f472b6', '#facc15', '#34d399', '#a78bfa', '#f87171', '#4ade80', '#fbbf24', '#c084fc', '#10b981'];
    const backgroundColors = labels.map((_, i) => colors[i % colors.length]);

    const ctx = document.getElementById('repBar').getContext('2d');
    if (repChart) repChart.destroy();
    repChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: backgroundColors,
          borderRadius: 5
        }]
      },
      options: {
        responsive: true,
        onClick: (evt, elements) => {
          if (elements.length > 0) {
            const idx = elements[0].index;
            const selectedRep = labels[idx];
            $('#repFilter').val([selectedRep]).trigger('change');
            loadData();
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => `₹${Number(ctx.raw).toLocaleString()}`
            }
          }
        },
        scales: {
          x: {
            ticks: { autoSkip: false, color: 'white', maxRotation: 90, minRotation: 45 }
          },
          y: {
            ticks: { color: 'white' }
          }
        }
      }
    });
  }

  function renderSummaries(data) {
    const s={}, c={}, d={};
    data.forEach(r => {
      s[r.state] = (s[r.state] || 0) + Number(r.billAmount);
      c[r.city] = (c[r.city] || 0) + Number(r.billAmount);
      d[r.distributor] = (d[r.distributor] || 0) + Number(r.billAmount);
    });
    sortAndFill(s, '#stateSummary');
    sortAndFill(c, '#citySummary');
    sortAndFill(d, '#distributorSummary');
  }

  function renderMetrics(data) {
    const total = data.reduce((sum, r) => sum + Number(r.billAmount), 0);
    const avg = data.length ? total / data.length : 0;
    const max = Math.max(...data.map(r => Number(r.billAmount)), 0);
    $('#totalSale').text(`₹${total.toLocaleString()}`);
    $('#avgSale').text(`₹${avg.toFixed(2)}`);
    $('#maxSale').text(`₹${max.toLocaleString()}`);
    $('#billCount').text(`${data.length}`);
  }

  function sortAndFill(obj, sel) {
    const arr = Object.entries(obj).sort((a, b) => b[1] - a[1]);
    const tbody = $(sel).empty();
    arr.forEach(([k, v]) => tbody.append(`<tr><td>${k}</td><td>₹${v.toLocaleString()}</td></tr>`));
  }

  function exportTable(tableId, filename) {
    const rows = document.querySelectorAll(`#${tableId} tr`);
    const data = Array.from(rows).map(row =>
      Array.from(row.cells).map(cell => cell.innerText.trim())
    );
    const ws = XLSX.utils.aoa_to_sheet([[...document.querySelector(`#${tableId}`).parentElement.querySelectorAll('th')].map(th => th.innerText), ...data]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, filename);
    XLSX.writeFile(wb, `${filename}.xlsx`);
  }

  $(document).ready(function () {
    loadData();

    $('#stateSummary').on('click', 'tr', function () {
      const state = $(this).find('td:first').text();
      $('#stateFilter').val([state]).trigger('change');
      loadData();
    });

    $('#citySummary').on('click', 'tr', function () {
      const city = $(this).find('td:first').text();
      $('#cityFilter').val([city]).trigger('change');
      loadData();
    });

    $('#distributorSummary').on('click', 'tr', function () {
      const distributor = $(this).find('td:first').text();
      $('#distributorFilter').val([distributor]).trigger('change');
      loadData();
    });
  });
</script>

</body>
</html>
