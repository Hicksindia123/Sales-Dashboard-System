<!DOCTYPE html>
<html>
<head>
  <title>Sales Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f3f3f3; }
    .metrics { display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; }
    .metric-card {
      background: white;
      padding: 15px 20px;
      margin: 10px;
      box-shadow: 0 2px 6px #ccc;
      border-radius: 8px;
      width: 23%;
      text-align: center;
    }
    .filter-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .filter-group label { display: flex; flex-direction: column; font-weight: bold; }
    .chart-section { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 20px; }
    canvas { background: white; border-radius: 8px; padding: 10px; width: 48% !important; height: 400px !important; }
    table {
      width: 100%; border-collapse: collapse; background: white;
    }
    th, td {
      border: 1px solid #ccc; padding: 8px; text-align: left;
    }
    th { background: #007BFF; color: white; }
  </style>
</head>
<body>

<h2>Sales Dashboard</h2>

<div class="metrics">
  <div class="metric-card" id="totalSale">Total Sale: ₹0</div>
  <div class="metric-card" id="avgSale">Average Sale: ₹0</div>
  <div class="metric-card" id="maxSale">Max Sale: ₹0</div>
  <div class="metric-card" id="billCount">Total Bills: 0</div>
</div>

<div class="filter-group">
  <label>From Date <input type="date" id="fromDate"></label>
  <label>To Date <input type="date" id="toDate"></label>
  <label>Rep <input type="text" id="repFilter" class="autocomplete"></label>
  <label>City <input type="text" id="cityFilter" class="autocomplete"></label>
  <label>State <input type="text" id="stateFilter" class="autocomplete"></label>
  <label>Distributor <input type="text" id="distributorFilter" class="autocomplete"></label>
  <button onclick="loadData()">Load</button>
</div>

<div class="chart-section">
  <canvas id="statePie"></canvas>
  <canvas id="repBar"></canvas>
</div>

<table id="salesTable">
  <thead>
    <tr>
      <th>Bill No.</th>
      <th>Bill Date</th>
      <th>Bill Amount</th>
      <th>Distributor</th>
      <th>City</th>
      <th>State</th>
      <th>Rep</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  let repList = [], cityList = [], distributorList = [], stateList = [], stateChart, repChart;

  function loadData() {
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;
    const repFilter = document.getElementById("repFilter").value.toLowerCase();
    const cityFilter = document.getElementById("cityFilter").value.toLowerCase();
    const stateFilter = document.getElementById("stateFilter").value.toLowerCase();
    const distributorFilter = document.getElementById("distributorFilter").value.toLowerCase();

    fetch(`https://script.google.com/macros/s/AKfycbzP8wroEEmje9M-fQfQZL3xOl01ilmgXG6vWR4gS_8mqQf1sj4nGmtoOqQzSeskHetXEA/exec?from=${from}&to=${to}`)
      .then(res => res.json())
      .then(data => {
        repList = [...new Set(data.rawData.map(r => r.rep))];
        cityList = [...new Set(data.rawData.map(r => r.city))];
        stateList = [...new Set(data.rawData.map(r => r.state))];
        distributorList = [...new Set(data.rawData.map(r => r.distributor))];
        enableAutocomplete();

        let filtered = data.rawData.filter(row =>
          (!repFilter || row.rep.toLowerCase().includes(repFilter)) &&
          (!cityFilter || row.city.toLowerCase().includes(cityFilter)) &&
          (!stateFilter || row.state.toLowerCase().includes(stateFilter)) &&
          (!distributorFilter || row.distributor.toLowerCase().includes(distributorFilter))
        );

        renderTable(filtered);
        renderSummary(filtered);
        renderPieChart(filtered);
        renderBarChart(filtered);
      });
  }

  function enableAutocomplete() {
    $("#repFilter").autocomplete({ source: repList });
    $("#cityFilter").autocomplete({ source: cityList });
    $("#stateFilter").autocomplete({ source: stateList });
    $("#distributorFilter").autocomplete({ source: distributorList });
  }

  function renderTable(data) {
    const tbody = document.querySelector("#salesTable tbody");
    tbody.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.billNo || "-"}</td>
        <td>${row.billDate}</td>
        <td>${row.billAmount}</td>
        <td>${row.distributor}</td>
        <td>${row.city}</td>
        <td>${row.state}</td>
        <td>${row.rep}</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderSummary(data) {
    const total = data.reduce((sum, r) => sum + Number(r.billAmount), 0);
    const avg = data.length ? (total / data.length).toFixed(2) : 0;
    const max = data.reduce((max, r) => Math.max(max, Number(r.billAmount)), 0);

    document.getElementById("totalSale").innerText = `Total Sale: ₹${total}`;
    document.getElementById("avgSale").innerText = `Average Sale: ₹${avg}`;
    document.getElementById("maxSale").innerText = `Max Sale: ₹${max}`;
    document.getElementById("billCount").innerText = `Total Bills: ${data.length}`;
  }

  function renderPieChart(data) {
    const ctx = document.getElementById('statePie').getContext('2d');
    if (stateChart) stateChart.destroy();

    const stateSales = {};
    data.forEach(row => {
      stateSales[row.state] = (stateSales[row.state] || 0) + Number(row.billAmount);
    });

    const labels = Object.keys(stateSales);
    const values = Object.values(stateSales);
    const colors = labels.map(() => `hsl(${Math.random()*360}, 70%, 70%)`);

    stateChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: colors
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'right'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.label} - ₹${context.raw.toLocaleString()}`;
              }
            }
          }
        }
      }
    });
  }

  function renderBarChart(data) {
    const ctx = document.getElementById('repBar').getContext('2d');
    if (repChart) repChart.destroy();

    const repSales = {};
    data.forEach(row => {
      repSales[row.rep] = (repSales[row.rep] || 0) + Number(row.billAmount);
    });

    const labels = Object.keys(repSales);
    const values = Object.values(repSales);

    repChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Rep Wise Sales',
          data: values,
          backgroundColor: 'skyblue'
        }]
      },
      options: { responsive: true }
    });
  }
</script>

</body>
</html>
