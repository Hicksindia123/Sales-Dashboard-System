<!DOCTYPE html>
<html>
<head>
  <title>Sales Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    body { font-family: Arial; padding: 20px; background: #f3f3f3; }
    .filter-group { margin-bottom: 20px; }
    select { min-width: 150px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: left; }
    thead th { background: #007BFF; color: white; }
    .summary-tables { display: flex; gap: 20px; flex-wrap: wrap; }
    .summary-box { width: 300px; max-height: 300px; overflow-y: auto; }
    .summary-box table { width: 100%; }
  </style>
</head>
<body>

<h2>Sales Dashboard</h2>

<div class="filter-group">
  From: <input type="date" id="fromDate">
  To: <input type="date" id="toDate">
  Rep: <select id="repFilter" multiple></select>
  City: <select id="cityFilter" multiple></select>
  State: <select id="stateFilter" multiple></select>
  Distributor: <select id="distributorFilter" multiple></select>
  <button onclick="loadData()">Load</button>
</div>

<div><canvas id="repBar" width="600" height="300"></canvas></div>

<div class="summary-tables">
  <div class="summary-box">
    <table>
      <thead><tr><th>State</th><th>Total Sale</th></tr></thead>
      <tbody id="stateSummary"></tbody>
    </table>
  </div>
  <div class="summary-box">
    <table>
      <thead><tr><th>City</th><th>Total Sale</th></tr></thead>
      <tbody id="citySummary"></tbody>
    </table>
  </div>
  <div class="summary-box">
    <table>
      <thead><tr><th>Distributor</th><th>Total Sale</th></tr></thead>
      <tbody id="distributorSummary"></tbody>
    </table>
  </div>
</div>

<table id="salesTable">
  <thead>
    <tr>
      <th>Bill No.</th>
      <th>Bill Date</th>
      <th>Bill Amount</th>
      <th>Distributor</th>
      <th>City</th>
      <th>State</th>
      <th>Rep</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  let repChart;

  function loadData() {
    const from = $('#fromDate').val();
    const to = $('#toDate').val();
    const repF = $('#repFilter').val() || [];
    const cityF = $('#cityFilter').val() || [];
    const stateF = $('#stateFilter').val() || [];
    const distF = $('#distributorFilter').val() || [];

    fetch(`https://script.google.com/macros/s/AKfycbyMFLEnwplCG2dNUMTT6R6ItCUlYWP6mJS6wPNbYKIeEzdVMIyCQUKiYpMaB5DY9Ac61g/exec?from=${from}&to=${to}`)
      .then(r => r.json())
      .then(data => {
        const raw = data.rawData;
        // Populate filter lists
        populateFilter('#repFilter', raw.map(r=>r.rep));
        populateFilter('#cityFilter', raw.map(r=>r.city));
        populateFilter('#stateFilter', raw.map(r=>r.state));
        populateFilter('#distributorFilter', raw.map(r=>r.distributor));

        // Filter data
        const filtered = raw.filter(r => {
          const dt = new Date(r.billDate+'T00:00:00');
          return (!from || dt >= new Date(from+'T00:00:00')) &&
                 (!to   || dt <= new Date(to+'T23:59:59')) &&
                 (repF.length == 0 || repF.includes(r.rep)) &&
                 (cityF.length == 0 || cityF.includes(r.city)) &&
                 (stateF.length == 0 || stateF.includes(r.state)) &&
                 (distF.length == 0 || distF.includes(r.distributor));
        });

        renderTable(filtered);
        renderBar(filtered);
        renderSummaries(filtered);
      });
  }

  function populateFilter(selector, list) {
    const u = Array.from(new Set(list.sort()));
    const el = $(selector).empty();
    u.forEach(v=> el.append(`<option>${v}</option>`));
    el.select2({ width: '150px', placeholder: 'Select' });
  }

  function renderTable(data) {
    const tbody = $('#salesTable tbody').empty();
    data.forEach(r => tbody.append(`
      <tr>
        <td>${r.billNo}</td><td>${r.billDate}</td><td>${r.billAmount}</td>
        <td>${r.distributor}</td><td>${r.city}</td><td>${r.state}</td><td>${r.rep}</td>
      </tr>`));
  }

  function renderBar(data) {
    const sales = {};
    data.forEach(r => sales[r.rep] = (sales[r.rep]||0)+Number(r.billAmount));
    const labels = Object.keys(sales), values=Object.values(sales);
    const ctx = document.getElementById('repBar').getContext('2d');
    if (repChart) repChart.destroy();
    repChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets:[{ data: values, backgroundColor:'skyblue' }] },
      options: { responsive:true }
    });
  }

  function renderSummaries(data) {
    const s={}, c={}, d={};
    data.forEach(r=>{
      s[r.state] = (s[r.state]||0)+Number(r.billAmount);
      c[r.city] = (c[r.city]||0)+Number(r.billAmount);
      d[r.distributor] = (d[r.distributor]||0)+Number(r.billAmount);
    });
    sortAndFill(s,'#stateSummary');
    sortAndFill(c,'#citySummary');
    sortAndFill(d,'#distributorSummary');
  }

  function sortAndFill(obj, sel) {
    const arr = Object.entries(obj).sort((a,b)=>b[1]-a[1]);
    const tbody = $(sel).empty();
    arr.forEach(([k,v])=> tbody.append(`<tr><td>${k}</td><td>â‚¹${v.toLocaleString()}</td></tr>`));
  }

  $(document).ready(loadData);
</script>

</body>
</html>
